name: Build and Release ZIP

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag to use for release (optional). If provided, release will use it.'
        required: false
        default: ''

jobs:
  build-and-release-zip:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1

      - name: Restore NuGet packages
        run: nuget restore "Ink Canvas.sln"

      - name: Build solution (Release)
        shell: pwsh
        run: |
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vswhere)) {
            Write-Host "vswhere not found at $vswhere"
            exit 1
          }
          $msbuildPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe | Select-Object -First 1
          if (-not $msbuildPath) {
            Write-Host "MSBuild.exe not found via vswhere"
            exit 1
          }
          Write-Host "Using MSBuild: $msbuildPath"
          & $msbuildPath "Ink Canvas.sln" /p:Configuration=Release /m
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Package Release output to ZIP
        shell: pwsh
        run: |
          $workspace = "${{ github.workspace }}"
          $projOut = Join-Path $workspace 'Ink Canvas\bin\Release'
          if (-not (Test-Path $projOut)) {
            Write-Host "Release output not found at $projOut"
            exit 1
          }
          New-Item -Path artifact -ItemType Directory -Force | Out-Null
          $zip = Join-Path $workspace 'artifact\InkCanvasForClass.zip'
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path (Join-Path $projOut '*') -DestinationPath $zip -Force
          Write-Host "Created ZIP: $zip"

      - name: Set release tag
        id: set_release_tag
        shell: pwsh
        run: |
          $tag = "${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag != '' && github.event.inputs.release_tag || github.ref_name || format('build-{0}', github.run_id) }}"
          Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_TAG=$tag"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "release_tag=$tag"

      - name: Check if release already exists
        id: check_release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ownerRepo = '${{ github.repository }}'
          $tag = '${{ steps.set_release_tag.outputs.release_tag }}'
          $headers = @{ Authorization = "token $env:GITHUB_TOKEN"; Accept = "application/vnd.github+json" }
          $api = "https://api.github.com/repos/$ownerRepo/releases/tags/$tag"
          try {
            $resp = Invoke-RestMethod -Headers $headers -Uri $api -Method Get
            Add-Content -Path $env:GITHUB_OUTPUT -Value "release_exists=true"
          } catch {
            Add-Content -Path $env:GITHUB_OUTPUT -Value "release_exists=false"
          }

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.set_release_tag.outputs.release_tag }}
          name: ${{ steps.set_release_tag.outputs.release_tag }}
          draft: false
          prerelease: false
          files: artifact/InkCanvasForClass.zip
          generate_release_notes: true
