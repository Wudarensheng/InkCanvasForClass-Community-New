name: Build and Release ZIP

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag to use for release (optional). If provided, release will use it.'
        required: false
        default: ''
  schedule:
    - cron: '0 0 * * *'  # 每天午夜运行

jobs:
  build-and-release-zip:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1

      - name: Restore NuGet packages
        run: nuget restore "Ink Canvas.sln"

      - name: Build solution (Release)
        shell: pwsh
        run: |
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vswhere)) {
            Write-Host "vswhere not found at $vswhere"
            exit 1
          }
          $msbuildPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe | Select-Object -First 1
          if (-not $msbuildPath) {
            Write-Host "MSBuild.exe not found via vswhere"
            exit 1
          }
          Write-Host "Using MSBuild: $msbuildPath"
          & $msbuildPath "Ink Canvas.sln" /p:Configuration=Release /m
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Package Release output to ZIP
        shell: pwsh
        run: |
          $workspace = "${{ github.workspace }}"
          $projOut = Join-Path $workspace 'Ink Canvas\bin\Release'
          if (-not (Test-Path $projOut)) {
            Write-Host "Release output not found at $projOut"
            exit 1
          }
          New-Item -Path artifact -ItemType Directory -Force | Out-Null
          $zip = Join-Path $workspace 'artifact\InkCanvasForClass.zip'
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path (Join-Path $projOut '*') -DestinationPath $zip -Force
          Write-Host "Created ZIP: $zip"

      - name: Configure Git
        shell: pwsh
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Extract version from commit or create new
        id: version
        shell: pwsh
        run: |
          # Get latest tag from repo
          $latestTag = $(git describe --tags --abbrev=0 2>$null)
          if (!$latestTag) {
            $latestTag = "v1.0.0"
          }
          
          # Parse version components
          $versionPattern = "^v(\d+)\.(\d+)\.(\d+)$"
          if ($latestTag -match $versionPattern) {
            $major = [int]$matches[1]
            $minor = [int]$matches[2]
            $patch = [int]$matches[3]
            
            # Increment patch version for new release
            $newPatch = $patch + 1
            $newTag = "v$major.$minor.$newPatch"
          } else {
            $newTag = "v1.0.1"
          }
          
          echo "NEW_TAG=$newTag" >> $env:GITHUB_ENV
          echo "release_tag=$newTag" >> $env:GITHUB_OUTPUT

      - name: Create Git Tag
        shell: pwsh
        run: |
          git tag $env:NEW_TAG
          git push origin $env:NEW_TAG

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        with:
          files: artifact/InkCanvasForClass.zip
          name: Release ${{ steps.version.outputs.release_tag }}
          tag_name: ${{ steps.version.outputs.release_tag }}
          draft: false
          prerelease: false
          body_path: ci发布的release版本
